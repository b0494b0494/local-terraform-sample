# Architecture and System Diagram

## System Overview

```
???????????????????????????????????????????????????????????????
?                    Local Development                         ?
???????????????????????????????????????????????????????????????

???????????????????         ???????????????????
?  Docker Compose ?         ?   Kubernetes     ?
?                 ?         ?   (Minikube/     ?
?  ?????????????  ?         ?    kind/k3d)    ?
?  ?sample-app ?  ?         ?                 ?
?  ?:8080      ?  ?         ?  ???????????????
?  ?????????????  ?         ?  ?sample-app  ??
?                 ?         ?  ?Namespace   ??
?  ?????????????  ?         ?  ?            ??
?  ?llm-app    ?  ?         ?  ???????????????
?  ?:8081      ?  ?         ?  ??Deployment???
?  ?????????????  ?         ?  ??(2 pods)  ???
???????????????????         ?  ???????????????
                            ?  ???????????????
                            ?  ??Service   ???
                            ?  ???????????????
                            ?  ???????????????
                            ?  ??ConfigMap ???
                            ?  ???????????????
                            ?  ???????????????
                            ?  ??Secret    ???
                            ?  ???????????????
                            ?  ???????????????
                            ?                 ?
                            ?  ???????????????
                            ?  ?monitoring ??
                            ?  ?Namespace  ??
                            ?  ?            ??
                            ?  ???????????????
                            ?  ??Prometheus???
                            ?  ???????????????
                            ?  ???????????????
                            ?  ??Grafana   ???
                            ?  ???????????????
                            ?  ???????????????
                            ?  ??Loki      ???
                            ?  ???????????????
                            ?  ???????????????
                            ?  ??Promtail  ???
                            ?  ??(DS)      ???
                            ?  ???????????????
                            ?  ???????????????
                            ???????????????????
```

## Component Diagram

```
??????????????????????????????????????????????????????????????
?                    Application Layer                        ?
??????????????????????????????????????????????????????????????
?                                                             ?
?  ????????????????              ????????????????           ?
?  ?  sample-app  ?              ?   llm-app    ?           ?
?  ?              ?              ?              ?           ?
?  ?  Flask       ?              ?  Flask +     ?           ?
?  ?  - /         ?              ?  Observability?          ?
?  ?  - /health ?              ?  - /chat     ?           ?
?  ?  - /ready  ?              ?  - /metrics  ?           ?
?  ?  - /info   ?              ?  - /traces   ?           ?
?  ????????????????              ????????????????           ?
?                                                             ?
??????????????????????????????????????????????????????????????
                            ?
                            ?
??????????????????????????????????????????????????????????????
?                 Kubernetes Infrastructure                  ?
??????????????????????????????????????????????????????????????
?                                                             ?
?  ????????????????  ????????????????  ????????????????   ?
?  ?  Deployment  ?  ?   Service    ?  ?   HPA         ?   ?
?  ?              ?  ?              ?  ?               ?   ?
?  ?  - Replicas  ?  ?  - ClusterIP ?  ?  - Auto-scale ?   ?
?  ?  - Probes    ?  ?  - LoadBal   ?  ?  - CPU based  ?   ?
?  ????????????????  ????????????????  ????????????????   ?
?                                                             ?
?  ????????????????  ????????????????  ????????????????   ?
?  ?  ConfigMap   ?  ?   Secret     ?  ?   Ingress    ?   ?
?  ?              ?  ?              ?  ?              ?   ?
?  ?  - App config?  ?  - API keys  ?  ?  - Routing   ?   ?
?  ????????????????  ????????????????  ????????????????   ?
?                                                             ?
?  ????????????????  ????????????????  ????????????????   ?
?  ?   PVC/PV     ?  ?ServiceAccount?  ?    RBAC      ?   ?
?  ?              ?  ?              ?  ?              ?   ?
?  ?  - Storage   ?  ?  - Identity  ?  ?  - Perms    ?   ?
?  ????????????????  ????????????????  ????????????????   ?
?                                                             ?
??????????????????????????????????????????????????????????????
                            ?
                            ?
??????????????????????????????????????????????????????????????
?                  Observability Stack                       ?
??????????????????????????????????????????????????????????????
?                                                             ?
?  ????????????????              ????????????????           ?
?  ?  Prometheus  ?              ?   Grafana    ?           ?
?  ?              ?              ?              ?           ?
?  ?  - Metrics   ????????????????  - Dashboards?          ?
?  ?  - Storage   ?              ?  - Queries   ?           ?
?  ?  - Scraping  ?              ?  - Alerts   ?           ?
?  ????????????????              ????????????????           ?
?         ?                           ?                     ?
?         ?                           ?                     ?
?  ????????????????              ????????????????           ?
?  ?   Promtail   ?              ?     Loki     ?           ?
?  ?              ?              ?              ?           ?
?  ?  - Collect   ????????????????  - Log store ?          ?
?  ?  - Forward   ?              ?  - Index     ?           ?
?  ????????????????              ????????????????           ?
?                                                             ?
??????????????????????????????????????????????????????????????
```

## Data Flow

### Request Flow
```
User/Client
    ?
    ?
???????????????????
?  Ingress (opt)  ?  ? External access
???????????????????
    ?
    ?
???????????????????
?    Service      ?  ? Load balancing
???????????????????
    ?
    ?
???????????????????
?     Pods        ?  ? Application instances
?  sample-app     ?
???????????????????
```

### Observability Flow
```
Application Pods
    ?
    ? (exposes /metrics)
    ?
???????????????????
?   Prometheus   ?  ? Scrapes metrics
???????????????????
    ?
    ?
???????????????????
?    Grafana      ?  ? Visualizes
???????????????????

Application Pods
    ?
    ? (logs to stdout)
    ?
???????????????????
?    Promtail     ?  ? Collects logs (DS)
???????????????????
    ?
    ?
???????????????????
?      Loki       ?  ? Stores logs
???????????????????
    ?
    ?
???????????????????
?    Grafana      ?  ? Queries logs
???????????????????
```

## Terraform Resource Hierarchy

```
terraform/
?
??? main.tf (Core Resources)
?   ??? Namespace
?   ??? ConfigMap
?   ??? Deployment
?   ??? Service
?
??? secrets.tf
?   ??? Secret
?
??? ingress.tf (optional)
?   ??? Ingress
?
??? hpa.tf (optional)
?   ??? HorizontalPodAutoscaler
?
??? storage.tf (optional)
?   ??? StorageClass
?   ??? PersistentVolume
?   ??? PersistentVolumeClaim
?
??? rbac.tf
?   ??? ServiceAccount
?   ??? Role
?   ??? RoleBinding
?
??? monitoring.tf (optional)
?   ??? Prometheus
?   ??? Grafana
?   ??? Loki
?   ??? Promtail
?
??? variables.tf
?   ??? All variables
?
??? outputs.tf
    ??? Resource outputs
```

## Network Architecture

```
???????????????????????????????????????????????????
?            Kubernetes Cluster                    ?
?                                                 ?
?  ???????????????????????????????????????????   ?
?  ?         sample-app Namespace            ?   ?
?  ?                                         ?   ?
?  ?  Pod ??? Service ??? Ingress ??? User   ?   ?
?  ?   ?                                  ?   ?   ?
?  ?   ???? ConfigMap                     ?   ?   ?
?  ?   ???? Secret                        ?   ?   ?
?  ?   ???? PVC (storage)                ?   ?   ?
?  ???????????????????????????????????????????   ?
?                                                 ?
?  ???????????????????????????????????????????   ?
?  ?        monitoring Namespace              ?   ?
?  ?                                         ?   ?
?  ?  Prometheus ???? Grafana ??? User       ?   ?
?  ?      ?                                   ?   ?
?  ?      ?                                   ?   ?
?  ?  App Pods (metrics)                     ?   ?
?  ?                                         ?   ?
?  ?  Loki ???? Promtail ??? App Pods (logs) ?   ?
?  ?    ?                                    ?   ?
?  ?    ?                                    ?   ?
?  ?  Grafana (log queries)                 ?   ?
?  ???????????????????????????????????????????   ?
?                                                 ?
???????????????????????????????????????????????????
```

## Security Layers

```
???????????????????????????????????????????????
?          Security Layers                    ?
???????????????????????????????????????????????
?                                             ?
?  1. RBAC (Role-Based Access Control)       ?
?     ??? ServiceAccount ? Role ? Permissions?
?                                             ?
?  2. Network Policies (optional)            ?
?     ??? Control pod-to-pod communication   ?
?                                             ?
?  3. Secrets Management                      ?
?     ??? Encrypted storage for credentials   ?
?                                             ?
?  4. Resource Limits                        ?
?     ??? CPU/Memory constraints per pod     ?
?                                             ?
?  5. Non-root containers                    ?
?     ??? Security context in Dockerfile     ?
?                                             ?
???????????????????????????????????????????????
```

## Deployment Flow

```
Developer
    ?
    ? git push
    ?
???????????????????
?  GitHub Actions ?
?       CI        ?  ? Test & Build
???????????????????
    ?
    ? (if main branch)
    ?
???????????????????
?  GitHub Actions ?
?       CD        ?  ? Deploy
???????????????????
    ?
    ? terraform apply
    ?
???????????????????
?  Kubernetes     ?
?   Cluster       ?  ? Resources created
???????????????????
```

## File Structure Overview

```
project-root/
??? Application
?   ??? app.py                    # Main Flask app
?   ??? llm_app.py                # LLM app with observability
?   ??? requirements.txt          # Dependencies
?
??? Infrastructure as Code
?   ??? main.tf                   # Core K8s resources
?   ??? variables.tf              # Configuration variables
?   ??? secrets.tf                # Secret management
?   ??? ingress.tf                # External access
?   ??? hpa.tf                    # Auto-scaling
?   ??? storage.tf                # Persistent storage
?   ??? rbac.tf                   # Security
?   ??? monitoring.tf             # Observability stack
?   ??? outputs.tf                # Output values
?
??? Configuration
?   ??? docker-compose.yml        # Local development
?   ??? Dockerfile                # Container image
?   ??? k8s-manifests.yaml        # Reference manifests
?   ??? terraform.tfvars.example  # Variable examples
?
??? CI/CD
?   ??? .github/workflows/
?       ??? ci.yml                # Continuous Integration
?       ??? cd.yml                # Continuous Deployment
?
??? Documentation
    ??? docs/
        ??? ARCHITECTURE.md       # This file
        ??? PRACTICE.md           # Exercises
        ??? QUICKREF.md           # Commands
        ??? TROUBLESHOOTING.md    # Debugging
        ??? ...                   # Other guides
```

## Resource Dependencies

```
Namespace (sample-app)
    ?
    ???? ConfigMap (app-config)
    ?       ?
    ?       ???? Deployment (references ConfigMap)
    ?
    ???? Secret (app-secret)
    ?       ?
    ?       ???? Deployment (references Secret)
    ?
    ???? ServiceAccount
    ?       ?
    ?       ???? RoleBinding
    ?       ?       ?
    ?       ?       ???? Role
    ?       ?
    ?       ???? Deployment (uses ServiceAccount)
    ?
    ???? Deployment
    ?       ?
    ?       ???? PVC (optional)
    ?       ?       ?
    ?       ?       ???? PV
    ?       ?
    ?       ???? HPA (references Deployment)
    ?
    ???? Service (references Deployment pods)
            ?
            ???? Ingress (optional, references Service)
```
